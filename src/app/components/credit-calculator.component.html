<div class="credit-calculator">
  <div class="header">
    <h1>Service Credit Calculator</h1>
    <p>Calculate credit for days without service based on invoice billing period</p>
    <div class="credit-line">Developed by Shujaat K. Umarkhan</div>
  </div>

  <div class="calculator-container">
    <!-- Tax Rate Section -->
    <div class="section">
      <h2>Tax Settings</h2>
      
      <div class="form-grid">
        <div class="form-group">
          <label for="taxRate">Tax Rate (%)</label>
          <input 
            type="number" 
            id="taxRate"
            [(ngModel)]="taxRate"
            step="0.1"
            min="0"
            max="100"
            class="form-control">
        </div>
      </div>
    </div>

    <!-- Services Section -->
    <div class="section">
      <div class="section-header">
        <h2>Services</h2>
        <button 
          type="button" 
          (click)="addService('', '', '', 0, '')"
          class="btn btn-primary btn-small">
          Add Service
        </button>
      </div>
      
      <div *ngIf="services().length === 0" class="no-services">
        <p>No services added. Click "Add Service" to begin.</p>
      </div>
      
      <div *ngFor="let service of services(); let i = index; trackBy: trackByServiceId" class="service-item">
        <div class="service-header">
          <h3>Service {{ i + 1 }}</h3>
          <button 
            type="button" 
            (click)="removeService(service.id)"
            class="btn btn-danger btn-small"
            [disabled]="services().length === 1">
            Remove
          </button>
        </div>
        
        <div class="form-grid">
          <div class="form-group">
            <label [for]="'serviceName' + service.id">Service Name</label>
            <input 
              type="text" 
              [id]="'serviceName' + service.id"
              [value]="service.serviceName"
              (blur)="updateService(service.id, 'serviceName', $any($event.target).value)"
              (keyup)="updateService(service.id, 'serviceName', $any($event.target).value)"
              placeholder="e.g., Internet Service"
              class="form-control"
              required>
          </div>
          
          <div class="form-group">
            <label [for]="'invoiceStartDate' + service.id">Invoice Start Date</label>
            <input 
              type="date" 
              [id]="'invoiceStartDate' + service.id"
              [value]="service.invoiceStartDate"
              (input)="updateService(service.id, 'invoiceStartDate', $any($event.target).value)"
              class="form-control"
              required>
          </div>
          
          <div class="form-group">
            <label [for]="'invoiceEndDate' + service.id">Invoice End Date</label>
            <input 
              type="date" 
              [id]="'invoiceEndDate' + service.id"
              [value]="service.invoiceEndDate"
              (input)="updateService(service.id, 'invoiceEndDate', $any($event.target).value)"
              class="form-control"
              required>
          </div>
          
          <div class="form-group">
            <label [for]="'pricePaid' + service.id">Amount Customer Paid</label>
            <input 
              type="number" 
              [id]="'pricePaid' + service.id"
              [value]="service.pricePaid"
              (input)="updateService(service.id, 'pricePaid', +$any($event.target).value || 0)"
              step="0.01"
              min="0"
              placeholder="0.00"
              class="form-control"
              required>
          </div>
          
          <div class="form-group">
            <label [for]="'actualServiceStartDate' + service.id">Actual Service Start Date</label>
            <input 
              type="date" 
              [id]="'actualServiceStartDate' + service.id"
              [value]="service.actualServiceStartDate"
              (input)="updateService(service.id, 'actualServiceStartDate', $any($event.target).value)"
              class="form-control"
              required>
            <small class="form-text">When did the customer actually start receiving this service?</small>
          </div>
        </div>
      </div>
    </div>

    <!-- Calculation Section -->
    <div class="section">
      <h2>Calculate Credit</h2>
      
      <div class="action-buttons">
        <button 
          type="button" 
          (click)="calculateCredit()"
          [disabled]="isCalculating()"
          class="btn btn-primary btn-large">
          <span *ngIf="isCalculating()">Calculating...</span>
          <span *ngIf="!isCalculating()">Calculate Credit Amount</span>
        </button>
        
        <button 
          type="button" 
          (click)="clearCalculation()"
          class="btn btn-secondary">
          Clear Results
        </button>
      </div>
    </div>

    <!-- Results Section -->
    <div class="section results-section" *ngIf="calculationResult()">
      <h2>Credit Calculation Results</h2>
      
      <div class="results-container">
        <!-- Summary Card -->
        <div class="result-summary">
          <div class="summary-card">
            <h3>Total Credit Amount</h3>
            <div class="amount-large">{{ formatCurrency(calculationResult()!.grandTotalWithTax) }}</div>
            <div class="amount-breakdown">
              <div>Credit: {{ formatCurrency(calculationResult()!.totalCreditAmount) }}</div>
              <div>Tax: {{ formatCurrency(calculationResult()!.totalTaxOnCredit) }}</div>
            </div>
          </div>
        </div>

        <!-- Individual Service Results -->
        <div class="detailed-results">
          <h3>Individual Service Credits</h3>
          
          <div *ngFor="let service of calculationResult()!.services; let i = index" class="service-result">
            <h4>{{ service.serviceName }}</h4>
            
            <div class="calc-details">
              <div class="calc-row">
                <span class="label">Invoice Period:</span>
                <span class="value">{{ formatDate(getServiceById(service.id)?.invoiceStartDate || '') }} to {{ formatDate(getServiceById(service.id)?.invoiceEndDate || '') }}</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Total Billing Days:</span>
                <span class="value">{{ service.totalBillingDays }} days</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Days Without Service:</span>
                <span class="value">{{ service.daysWithoutService }} days</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Amount Paid:</span>
                <span class="value">{{ formatCurrency(getServiceById(service.id)?.pricePaid || 0) }}</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Daily Rate:</span>
                <span class="value">{{ formatCurrency(service.dailyRate) }}</span>
              </div>
              
              <div class="calc-row highlight">
                <span class="label">Credit Amount:</span>
                <span class="value">{{ formatCurrency(service.creditAmount) }}</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Tax on Credit:</span>
                <span class="value">{{ formatCurrency(service.taxOnCredit) }}</span>
              </div>
              
              <div class="calc-row total">
                <span class="label">Total Credit with Tax:</span>
                <span class="value">{{ formatCurrency(service.totalCreditWithTax) }}</span>
              </div>
            </div>
          </div>
          
          <!-- Combined Totals -->
          <div class="combined-totals" *ngIf="calculationResult()!.services.length > 1">
            <h4>Combined Totals</h4>
            <div class="calc-details">
              <div class="calc-row">
                <span class="label">Tax Rate:</span>
                <span class="value">{{ taxRate() }}%</span>
              </div>
              
              <div class="calc-row highlight">
                <span class="label">Total Credit Amount:</span>
                <span class="value">{{ formatCurrency(calculationResult()!.totalCreditAmount) }}</span>
              </div>
              
              <div class="calc-row">
                <span class="label">Total Tax on Credits:</span>
                <span class="value">{{ formatCurrency(calculationResult()!.totalTaxOnCredit) }}</span>
              </div>
              
              <div class="calc-row total">
                <span class="label">Grand Total with Tax:</span>
                <span class="value">{{ formatCurrency(calculationResult()!.grandTotalWithTax) }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>